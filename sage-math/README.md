# CTO template plugin

This plugin can be used as a template to develop new plugins for [CrypTool-Online](https://cryptool.org/cto) (CTO). It already has a structure set up and includes a `gulpfile` for automating the building process. This is a guide on how to use it.


-----


## Table of Contents

* [What are CTO plugins and how are they loaded?](#what-are-cto-plugins-and-how-are-they-loaded)
* [0. Get CTO running locally](#0-get-cto-running-locally)
* [1. Building the template plugin](#1-building-the-template-plugin)
* [2. Customizing the template plugin](#2-customizing-the-template-plugin)
  * [2.1 Decide the plugins name](#21-decide-the-plugins-name)
  * [2.2 Adapt the config file](#22-adapt-the-config-file)
  * [2.3 Write your own HTML markup](#23-write-your-own-html-markup)
  * [2.4 Write your JS logic and CSS styles](#24-write-your-js-logic-and-css-styles)
  * [2.5 Translate the plugin](#25-translate-the-plugin)
* [3. Running the plugin in CTO](#3-running-the-plugin-in-cto)
  * [3.1 Development Workflow](#31-development-workflow)
  * [3.2 Deploying the plugin to the website](#32-deploying-the-plugin-to-the-website)
* [4. Additional information](#4-additional-information)
  * [4.1 Adding multiple scripts or stylesheets to the config file](#41-adding-multiple-scripts-or-stylesheets-to-the-config-file)
  * [4.2 Set global JS variables via config](#42-set-global-js-variables-via-config)
  * [4.3 Translating strings in JS files](#43-translating-strings-in-js-files)
  * [4.4 Adding third party libraries](#44-adding-third-party-libraries)
  * [4.5 Customizing the gulpfile](#45-customizing-the-gulpfile)
  * [4.6 Including files with gulp](#46-including-files-with-gulp)

-----


## What are CTO plugins and how are they loaded?

**What they are:** CTO plugins are independent website parts that can be included into [CrypTool-Online](https://www.cryptool.org/cto). They contain a config file named `cto.config.json` that references all HTML files, CSS stylesheets, and JS scripts that shall be included.

**How they are loaded:** The [CrypTool Portal](https://www.cryptool.org) uses Jekyll (a static website generator) to generate its website and Jekyll is also used to include plugins into CTO. A custom Jekyll plugin replaces all occurences of the placeholder `{% loadCtoApp PLUGIN %}` with the contents referenced in the plugins config file located at `_ctoApps/PLUGIN/cto.config.json`. More on that later.


-----


## 0. Get CTO running locally

CTO plugins will run inside of CTO. CTO is part of the CrypTool Portal, which is a website generated by the static site generator Jekyll.

The Jekyll project has to be initialized to run plugins inside of it. You can do that now or later, but it's recommended to do it before developing a new plugin, so that you can view changes on your plugin directly in CTO while developing.

> You will find a guide on how to run CTO locally [here](https://github.com/z11labs/cryptool.org#1-cloning-and-building). This is a private repository, so you'll have to be invited.

> It's also recommended to fork that repository, so you can create pull requests when [deploying to CTO](#32-deploying-the-plugin-to-the-website).


-----


## 1. Building the template plugin

The template plugin requires the local installation of `Node.JS` (including `NPM`). If you don't have it installed already, install it first. If you are using Linux, there probably are prebuilt packages for your distribution. If you are using Windows, download it from here: [Node.JS download](https://nodejs.org/en/download).

When you have Node.JS installed, install the template plugins dependencies with:

```shell
$ npm install
```

After installing the dependencies, you can build the plugin by running `Gulp`:

```shell
$ gulp
```

Now, a folder called `dist` should have been created. It contains the pre-built files that we can copy into the [CrypTool-Online Jekyll project](https://github.com/z11labs/cryptool.org). More to that later.


-----


## 2. Customizing the template plugin

As you have successfully built the template plugin, you are ready to customize the plugin to your own plugins needs.


### 2.1 Decide the plugins name

Everytime the string `template` is being used in filenames, foldernames, or inside of the source code, it is a reference to the name of the plugin. Therefore, decide a short name for your new plugin and rename. Replace every occurence of the string `template` with the new name.

In the current state, all occurences are the following:

* Folders and files: `template`, `src/template`, `src/template/locales/de/template.json`, `src/template/locales/en/template.json`
* Source code: `cto.config.json`, `fragment.html`

For this guide, let's assume we renamed all occurences of `template` to `new-plugin`.


### 2.2 Adapt the config file

The config file `cto.config.json` references all files that will be included when loading the plugin into CTO. It includes an HTML fragment, CSS stylesheets, and JS scripts. Here is how it looks now:

```json
{

    "name": "new-plugin",

    "styles": [
        "styles.css"
    ],

    "scripts": [
        "script.js"
    ],

    "html": "fragment-%lang%.html"

}
```

You don't have to change anything here (except replacing `template` with `new-plugin`), but you could also [add multiple scripts or stylesheets](#51-adding-multiple-scripts-or-stylesheets-to-the-config-file) or [add global JS variables](#52-set-global-js-variables-via-config).

Notice that there is a placeholder `%lang%` in the `html` filename. That is for translating and we will get to that later when we [2.5 Translate the plugin](#25-translate-the-plugin).

What will happen (when we load the plugin into CTO) is, that the HTML fragment file at `html` will be included into the HTML source code of the plugins page and the CSS stylesheets and JS scripts will be loaded into that page as well. We'll get on how to do it later in [3. Running the plugin in CTO](#3-running-the-plugin-in-cto).


### 2.3 Write your own HTML markup

Now we finally get to create the contents of your new plugin. This is where this guide can't help you :D Inside of the `fragment.html` you can add all the HTML markup that your plugin will need. For example add text inputs, buttons, etc.

> **Please note** that all components should use Bootstrap classes for a consistent look and feel. Please have a look into Bootstrap's documentation: Especially [which components are available](https://getbootstrap.com/docs/4.5/components) and [how to layout for desktop and mobile](https://getbootstrap.com/docs/4.5/layout).

> **Also,** the website already contains libraries like Bootstrap and jQuery. Therefore they should not be extra included inside of your plugin. You can just use Bootstrap components and jQuery methods like that.

**Pro-Tip:** You may want to [include files with gulp](#56-including-files-with-gulp) if you are developing complex HTML structures. Or you may want to use frameworks like React or Vue, which is fine too.


### 2.4 Write your JS logic and CSS styles

Parallel to creating your HTML markup, you probably want to add some functionality to your plugin. This can be done via JavaScript (JS) inside of `script.js` or any other scripts you create. [JS scripts can also be translated](#53-translating-strings-in-js-files). Preprocessors like `TypeScript` can also be used but must be processed into vanilla JS by [4.5 Customizing the `gulpfile`](#55-customizing-the-gulpfile) first.

The styling of elements can be done via CSS inside of `styles.css` or any other stylesheets you create. Preprocessors like `SCSS` can also be used but must be processed into pure CSS by [4.5 Customizing the `gulpfile`](#55-customizing-the-gulpfile) first.

Btw, here is how you could [add third party libraries](#54-adding-third-party-libraries).


### 2.5 Translate the plugin

Gulp provides packages for translating during the build. You can translate a string by replacing it with a placeholder and adding the translations to localization JSON files:

Lets assume, this is a part of your `fragment.html`:

```html
... <h1>Hello world, this is an example</h1> ...
```

1) **Replace the text you want to translate with a placeholder.** Placeholders consist of the file their translations are located in and the key of the JSON object inside of it. In this case, the translations are located in `src/new-plugin/locales/de|en/new-plugin.json` and we'll give it the key `heading`.

Therefore, with the placeholder it will look like this:

```html
... <h1>${{ new-plugin.heading }}$</h1> ...
```

2) **Add translations to locales JSON files.** The JSON files contain a JSON object that contains key-value-pairs. The key from the upper example is `heading`. So open the files `src/new-plugin/locales/de/new-plugin.json` and `src/new-plugin/locales/en/new-plugin.json` and add the translations. You can create as many of these JSON files as you want btw.

`src/new-plugin/locales/de/new-plugin.json`:

```json
{
    ...,
    "heading": "Hallo Welt, dies ist ein Beispiel",
    ...
}
```

`src/new-plugin/locales/en/new-plugin.json`:

```json
{
    ...,
    "heading": "Hello world, this is an example",
    ...
}
```

3) Rebuild the plugin with `gulp` so that the new translations will be applied:

```shell
$ gulp
```

4) To view the changes, [run the plugin in CTO](#3-running-the-plugin-in-cto).


-----


## 3. Running the plugin in CTO

The following steps only have to be executed once. It may take a little time to set everything up, but once it's set up, running and deploying is easy. The actual developing workflow is described in [3.1 Development Workflow](#31-development-workflow).

#### Initialize the project containing CTO

To run the new plugin in CTO, you first have to run the [cryptool.org project](https://github.com/z11labs/cryptool.org), which includes CTO. The best way to contribute is to fork the project and to develope inside of that fork. This makes it easy to [deploy your plugin](#32-deploying-the-plugin-to-the-website), as you can just open a Pull Request then, that can be reviewed by an operator.

1) So first, go to https://github.com/z11labs/cryptool.org and click the "Fork" button. This will create you a copy of the project which you can then "clone", which is downloading it to your PC.

2) Then clone, install, and build the project as [described in the readme file](https://github.com/z11labs/cryptool.org#1-cloning-and-building). Use your fork URL to clone instead of the one in the readme.

#### Create entry pages for your plugin

To make your plugin have an URL that it can be reached at, create an entry page for your plugin inside of your forked cryptool.org project version:

1) Create the file `_pages/cto/new-plugin.html` (replace `new-plugin` with the name of your plugin of course) and add the following content. It will serve as the entry page.

```yml
---
titles:
    en: New Plugin
    de: Neues Plugin
---

{% translate_file cto/plugins/new-plugin.html %}
```

Also replace `new-plugin` with the name of your plugin of course. The variables below `titles` are the language specific HTML head titles of your plugins page.

2) The page we created refers to `cto/plugins/new-plugin.html`, which are the language translated files that will be displayed when browsing to the entry page. We will now create those, one for every language:

Create `_i18n/en/cto/plugins/new-plugin.html` and add the following (english) content:

```html
<h2 class="main-heading">New Plugin</h2>

<!-- Nav tabs -->
<ul class="nav nav-tabs">
    <li class="nav-item"><a class="nav-link active" href="#cipher" data-toggle="tab">Cipher</a></li>
    <li class="nav-item"><a class="nav-link" href="#description" data-toggle="tab">Description</a></li>
</ul>

<!-- Tab panes -->
<div class="tab-content">

    <div id="cipher" class="tab-pane active">
        {% loadCtoApp new-plugin %}
    </div>

    <div id="description" class="tab-pane">
        ... add info about your plugin here later ...
    </div>

</div>
```

Create `_i18n/de/cto/plugins/new-plugin.html` and add the following (german) content:

```html
<h2 class="main-heading">Neues Plugin</h2>

<!-- Nav tabs -->
<ul class="nav nav-tabs">
    <li class="nav-item"><a class="nav-link active" href="#cipher" data-toggle="tab">Chiffre</a></li>
    <li class="nav-item"><a class="nav-link" href="#description" data-toggle="tab">Beschreibung</a></li>
</ul>

<!-- Tab panes -->
<div class="tab-content">

    <div id="cipher" class="tab-pane active">
        {% loadCtoApp new-plugin %}
    </div>

    <div id="description" class="tab-pane">
        ... hier später eine Beschreibung hinzufügen ...
    </div>

</div>
```

Replace `new-plugin` with the name of your plugin in both files again.

The line `{% loadCtoApp new-plugin %}` will be replaced by Jekyll with the contents from the config file of your plugin. The only thing left to do right now, is to build the plugin files and to copy them inside the cryptool.org project.

#### Build plugin files and copy to `_ctoApps` folder

1) Build your plugin with gulp (inside of your plugin directory):

```bash
$ gulp
```

2) Copy built files to `_ctoApps` inside of the cryptool.org project:

```bash
$ cp -rf dist/new-plugin ~/cryptool.org/_ctoApps
```

#### Serve the cryptool.org project and browse to your plugin

Open another terminal, navigate to your cryptool.org project folder, and execute:

```bash
$ gulp serve
```

This serves up CTO and your plugin will then be visible at: http://localhost:3000/en/cto/new-plugin.html


### 3.1 Development Workflow

While developing, you may often want to change small things in your code and have a look at the generated result in your browser. Therefore, the cryptool.org project offers a mechanism to reload everything (even your browser) on file changes. So you can just build your plugin files, copy them into `_ctoApps`, and CTO will be automatically rebuilt and your browser windows will be reloaded.

Serve cryptool.org project (creates file change listener, only required once):

```bash
$ gulp serve
```

_Let's now assume you make some changes to your plugin files._

Open another terminal and navigate to your plugin directory.

Rebuild your plugin with gulp (in your plugin directory):

```bash
$ gulp
```

Now copy the generated files (`dist` folder) to `_ctoApps` in the cryptool.org directory:

```bash
$ cp -rf dist/new-plugin ~/cryptool.org/_ctoApps
```

The terminal running `gulp serve` in the cryptool.org directory should now register the change and rebuild the project. You should be able to see the progress in the terminal. If it does not automatically rebuild, you can also terminate the command (`Ctrl` + `C`) and run `gulp serve` again.

Your plugin should now be available at http://localhost:3000/en/cto/new-plugin.html


### 3.2 Deploying the plugin to the website

Now that you developed and TESTED your plugin, it's time to deploy it to the CTO website. There are two different repositories: [ct-online/cto](https://github.com/ct-online/cto) contains the **source code** of all plugins and [z11labs/cryptool.org](https://github.com/z11labs/cryptool.org) contains the **prebuilt plugin files** and the CTO website.

This is due to security reasons: Having the source code of the plugins inside of the website repository would require us to build the plugins on the server. And as Gulp is able to run local code, this would not be adiquate. Therefore, the **plugins are built locally** and only the prebuild files will be pushed into the CTO website. The source code remains in [ct-online/cto](https://github.com/ct-online/cto).

To continue, you should have followed the steps in [3. Running the plugin in CTO](#3-running-the-plugin-in-cto) locally. Now we're just deploying to the remote website.

#### 3.2.1 Push the prebuild files into CTO website

If you haven't done it already, fork and clone the repository [z11labs/cryptool.org](https://github.com/z11labs/cryptool.org) and build your plugin by running `gulp` in your plugin directory. Then, copy the prebuilt files from the folder `dist/new-plugin` from your plugin folder into `_ctoApps/new-plugin` of the cryptool.org project folder:

```bash
$ cp -rf dist/new-plugin ~/cryptool.org/_ctoApps
```

You should also already have pages created for your plugin.

[Make sure, that you are working on the forked repository by checking if the local repository's _remote_ is set to your account](#323-check-if-the-repository-is-set-to-your-fork).

Now commit and push your changes into your forked repository. Navigate to your `cryptool.org` directory and create another branch for your changes:

```bash
$ git pull origin master
$ git branch -b new-plugin master
```

Now add your changed files and push to your fork:

```bash
$ git add _ctoApps/new-plugin
$ git add _pages/cto/new-plugin.html
$ git add _i18n/de/cto/plugins/new-plugin.html
$ git add _i18n/en/cto/plugins/new-plugin.html
$ git commit -m "Add CTO plugin 'new-plugin'"
$ git push origin new-plugin
```

After pushing your changes to your fork, [create a Pull Request to the original repository](https://docs.github.com/en/github/collaborating-with-pull-requests/proposing-changes-to-your-work-with-pull-requests/creating-a-pull-request-from-a-fork).

Now your changes will be reviewed by an operator and merged into the original repository.


#### 3.2.2 Push the source code to ct-online/cto

If you haven't done it already, fork and clone the repository [ct-online/cto](https://github.com/ct-online/cto). Then copy the source files of your plugin to `_ctoApps` in the forked repository.

[Make sure, that you are working on the forked repository by checking if the local repository's _remote_ is set to your account](#323-check-if-the-repository-is-set-to-your-fork).

Now commit and push your changes into your forked repository. Navigate to your `cto` directory and create another branch for your changes:

```bash
$ git pull origin master
$ git branch -b new-plugin master
```

Now add your changed files and push to your fork:

```bash
$ git add _ctoApps/new-plugin
$ git commit -m "Add CTO plugin 'new-plugin'"
$ git push origin new-plugin
```

After pushing your changes to your fork, [create a Pull Request to the original repository](https://docs.github.com/en/github/collaborating-with-pull-requests/proposing-changes-to-your-work-with-pull-requests/creating-a-pull-request-from-a-fork).

Now your changes will be reviewed by an operator and merged into the original repository.


#### 3.2.3 Check if the repository is set to your fork

Make sure, that you are working on the forked repository by checking if the local repository's _remote_ is set to your account:

```bash
$ git remote -v
```

The output should be something like this:

```
origin	git@github.com:YOURUSERNAME/cryptool.org.git (fetch)
origin	git@github.com:YOURUSERNAME/cryptool.org.git (push)
```

If the output does not contain your GitHub username, you should set the URL accordingly:

```bash
$ git remote set-url origin git@github.com:YOURUSERNAME/cryptool.org.git
```

> Note: This example uses SSH for accessing the repository. You can also use HTTPS instead.

> For accessing via SSH, you will need to [add a SSH key to your GitHub account](https://docs.github.com/en/authentication/connecting-to-github-with-ssh/adding-a-new-ssh-key-to-your-github-account). For using HTTPS, your will need to [create a personal access token](https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/creating-a-personal-access-token).


-----


## 4. Additional information

We have now covered how to use the template plugin and how you can develop a basic new plugin with it. But there can be done more. This will be covered here.


### 4.1 Adding multiple scripts or stylesheets to the config file

You can also rename or add more scripts to the config file `cto.config.json` for example:

```json
"styles": [
    "one-stylesheet.css",
    "another-stylesheet.css"
],

"scripts": [
    "one-script.js",
    "another-script.js"
]
```


### 4.2 Set global JS variables via config

It is possible to set global JavaScript variables via the `cto.config.json` file. This can be any type of JSON object and is set at the key `globals`. This would look like this:

```json
...,
"globals": {
    "myVariable": "variable value"
}
...
```

These values will be available in the JS code at the global variable `CTO_Globals`, you can refer to it like this:

```js
CTO_Globals.myVariable
```

There also are predefined values at `CTO_Globals`, which are:

```json
{
    "base": "https://www.cryptool.org",
    "pluginRoot": "/_ctoApps/new-plugin/"
}
```


### 4.3 Translating strings in JS files

JavaScript files can be translated as well. The translation will also be taken care of by the `gulpfile.js`. In the gulpfile of this template, there already is a line that will translate JS files. Uncomment this line (line 42) by removing the leading slashes:

```js
    .pipe(translate())
```

This will then parse all `.js`-files and replace placeholders with translated strings. **Notice:** This will create multiple JS files as output (one for every language). Therefore, add a placeholder for the language flag to `cto.config.json`. This is analog to the translation of `fragment.html`.

Currently, the `cto.config.json` should look like this:

```json
...
    "scripts": [
        "script.js"
    ],
...
```

Add the placeholder so it looks like this:

```json
...
    "scripts": [
        "script-%lang%.js"
    ],
...
```

Now you can also translate strings in the JS files like in [2.5 Translating the plugin](#25-translating-the-plugin).


### 4.4 Adding third party libraries

Third party JS libraries can either be pulled from a CDN or downloaded into the plugin directory. They can then be referenced in `cto.config.json`:

Pulled from a CDN:

```json
...
    "scripts": [
        "https://cdn.jsdelivr.net/npm/random/dist/cjs/index.min.js"
    ],
...
```

Downloaded into the plugin directory:

```json
...
    "scripts": [
        "path/to/file/index.min.js"
    ],
...
```


### 4.5 Customizing the gulpfile

Feel free to customize the `gulpfile.js`. It contains tasks that will be executed when you run `gulp` and can help a lot with automating build tasks. For example, when you want to minify the outputs, you can use a gulp plugin for that. Or when you want to use things like SCSS or TypeScript, there also are gulp plugins for that. Here's a [list of popular gulp plugins](https://gulpjs.com/plugins).


### 4.6 Including files with gulp

Gulp can be used to distribute your code above multiple files. This can be useful for reusing code or to maintain some order when your files get very large.

Let's assume you have a file called `options.html` which is included into multiple files of your plugin:

`options.html`:
```html
<div class="options">
    This is our options file.
</div>
```

Let's assume you want to include this file into another file called `index.html`.

`index.html`:
```html
<div class="index">
    @@include("./options.html")
</div>
```

The result would be `index.html` containing:

```html
<div class="index">
    <div class="options">
        This is our options file.
    </div>
</div>
```

You can also pass variables to included files:

`index.html`:
```html
<div class="index">
    @@include("./options.html", {
        "name": "new-plugin",
        "anotherVariable": "${{ new-plugin.TRANSLATION }}$"
    })
</div>
```

`options.html`:
```html
<div class="options">
    This is our options file for @@name with @@anotherVariable.
</div>
```

> Note: This assumes that `TRANSLATION` is set in `src/new-plugin/locales/de|en/new-plugin.json`. Let's assume it is set to "something translated". When translating, the files will get a language suffix.

The result would then be:

`index-en.html`:
```html
<div class="index">
    <div class="options">
        This is our options file for new-plugin with something translated.
    </div>
</div>
```

More examples can be found at [the official docs of `gulp-file-include`](https://www.npmjs.com/package/gulp-file-include).
